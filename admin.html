<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - BlessedShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-gray-800 text-white p-4 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">üôè BlessedShop Admin</h1>
            <div class="flex gap-6">
                <a href="index.html" class="hover:text-gray-300">Home</a>
                <a href="order-tracking.html" class="hover:text-gray-300">üìä Order Tracking</a>
                <button id="logoutBtn" class="hover:text-gray-300">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Admin Section -->
    <section class="py-12 bg-gray-100 min-h-screen">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold mb-8">Admin Dashboard</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm">Total Products</p>
                    <p id="totalProducts" class="text-3xl font-bold">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm">Total Orders</p>
                    <p id="totalOrders" class="text-3xl font-bold">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm">Total Revenue</p>
                    <p id="totalRevenue" class="text-3xl font-bold">‚Ç¶0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="text-gray-600 text-sm">Total Users</p>
                    <p id="totalUsers" class="text-3xl font-bold">0</p>
                </div>
            </div>

            <!-- Add Product Form -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <h3 class="text-2xl font-bold mb-6">Add New Product</h3>
                <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="productName" placeholder="Product Name" class="border rounded-lg px-4 py-2" required>
                    <input type="number" id="productPrice" placeholder="Price" class="border rounded-lg px-4 py-2" step="0.01" required>
                    <textarea id="productDescription" placeholder="Description" class="border rounded-lg px-4 py-2 md:col-span-2"></textarea>
                    <select id="productCategory" class="border rounded-lg px-4 py-2" required>
                        <option value="">Select Category</option>
                        <option value="phones">Phones</option>
                        <option value="cars">Cars</option>
                        <option value="shoes">Shoes</option>
                        <option value="electronics">Electronics</option>
                    </select>
                    <input type="text" id="productImage" placeholder="Image URL" class="border rounded-lg px-4 py-2" required>
                    <button type="submit" class="md:col-span-2 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 font-bold">Add Product</button>
                </form>
            </div>

            <!-- Pending Bank Transfer Orders -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                <h3 class="text-2xl font-bold mb-6">‚è≥ Pending Bank Transfer Orders</h3>
                
                <!-- Search Bar -->
                <div class="mb-4 flex gap-2">
                    <input type="text" id="pendingSearchInput" placeholder="Search by Order ID or Email..." class="flex-1 border rounded-lg px-4 py-2">
                    <button onclick="searchPendingOrders()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">üîç Search</button>
                    <button onclick="loadPendingBankTransfers()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">üîÑ Refresh</button>
                </div>

                <div id="pendingOrdersList" class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-yellow-100">
                            <tr>
                                <th class="px-4 py-2">Order ID</th>
                                <th class="px-4 py-2">Customer</th>
                                <th class="px-4 py-2">Email</th>
                                <th class="px-4 py-2">Amount</th>
                                <th class="px-4 py-2">Proof</th>
                                <th class="px-4 py-2">Created</th>
                                <th class="px-4 py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingOrdersTable">
                            <tr><td colspan="7" class="px-4 py-2 text-gray-500">No pending orders</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Products List -->
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h3 class="text-2xl font-bold mb-6">Products</h3>
                <div id="productsList" class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-4 py-2">Name</th>
                                <th class="px-4 py-2">Category</th>
                                <th class="px-4 py-2">Price</th>
                                <th class="px-4 py-2">Description</th>
                                <th class="px-4 py-2">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <!-- Products loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 text-center">
        <p>&copy; 2025 BlessedShop. All rights reserved.</p>
    </footer>

    <script src="js/firebase.js"></script>
    <!-- Firebase compat SDKs (loaded only for Firestore/Auth/Storage support) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="js/firebase-client.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/db.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = getCurrentUser();
            
            if (!user || user.email !== 'admin@blessedshop.com') {
                alert('Access denied! Admin only.');
                window.location.href = 'index.html';
                return;
            }

            await loadProducts();
            await loadStats();
            loadPendingBankTransfers();
        });

        function loadPendingBankTransfers() {
            // If Firebase is initialized, use Firestore realtime listener
            if (window.fb && fb.db) {
                try {
                    // Unsubscribe previous listener if any
                    if (window._pendingUnsubscribe) {
                        try { window._pendingUnsubscribe(); } catch (e) { /* ignore */ }
                    }

                    window._pendingUnsubscribe = fb.db.collection('pendingBankTransfers')
                        .orderBy('createdAtTS', 'desc')
                        .onSnapshot(snapshot => {
                            const orders = snapshot.docs.map(d => {
                                const data = d.data();
                                // normalize timestamp fields to ISO strings for display
                                if (data.createdAtTS && data.createdAtTS.toDate) {
                                    data.createdAt = data.createdAtTS.toDate().toISOString();
                                } else if (data.createdAt && data.createdAt.toDate) {
                                    data.createdAt = data.createdAt.toDate().toISOString();
                                }
                                // keep the doc id too in case we need it
                                data.__docId = d.id;
                                return data;
                            });
                            console.debug('Firestore pendingBankTransfers snapshot:', orders);
                            window.allPendingOrders = orders;
                            displayPendingOrders(orders);
                        }, err => {
                            console.error('Error listening to pendingBankTransfers:', err);
                            // fallback to localStorage on error
                            loadPendingBankTransfers_local();
                        });

                    return;
                } catch (err) {
                    console.error('Failed to initialize Firestore listener, falling back to localStorage:', err);
                    // continue to localStorage fallback
                }
            }

            // localStorage fallback
            loadPendingBankTransfers_local();
        }

        function loadPendingBankTransfers_local() {
            try {
                const pendingOrders = JSON.parse(localStorage.getItem('pendingBankTransfers')) || [];
                console.debug('Loaded pendingBankTransfers (local):', pendingOrders);
                window.allPendingOrders = pendingOrders; // Store for searching
                displayPendingOrders(pendingOrders);
            } catch (err) {
                console.error('Error loading pending bank transfers (local):', err);
                const tbody = document.getElementById('pendingOrdersTable');
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-red-500">Error loading pending orders (see console)</td></tr>';
            }
        }

        function displayPendingOrders(orders) {
            const tbody = document.getElementById('pendingOrdersTable');

            try {
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-gray-500">No pending orders</td></tr>';
                    return;
                }

                // Build rows defensively so a malformed order doesn't break the whole table
                const rows = [];
                for (const order of orders) {
                    try {
                        const id = order && order.id ? order.id : '(no-id)';
                        const firstName = order && order.customer && (order.customer.firstName || order.customer.name) ? (order.customer.firstName || order.customer.name.split(' ')[0]) : '';
                        const lastName = order && order.customer && (order.customer.lastName) ? order.customer.lastName : '';
                        const email = order && order.customer && order.customer.email ? order.customer.email : 'N/A';

                        // Safely get amount
                        let totalAmount = 0;
                        if (order && order.amounts && typeof order.amounts.total === 'number') {
                            totalAmount = order.amounts.total;
                        } else if (order && order.amounts && order.amounts.total) {
                            totalAmount = Number(order.amounts.total) || 0;
                        }

                        const amountStr = '‚Ç¶' + (Number.isFinite(totalAmount) ? totalAmount.toLocaleString() : '0');

                        const hasProof = order && order.paymentProof && (order.paymentProof.dataUrl || order.paymentProof.fileName);
                        const proofBtn = hasProof ? `<button onclick="viewProof('${id}')" class="text-blue-600 hover:underline">üì∏ View</button>` : '<span class="text-gray-400 text-xs">No Proof</span>';

                        let created = 'Unknown';
                        if (order && order.createdAt) {
                            const d = new Date(order.createdAt);
                            if (!isNaN(d)) created = d.toLocaleDateString();
                        }

                        rows.push(`
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2 font-mono text-xs font-bold text-blue-600">${id}</td>
                                <td class="px-4 py-2">${firstName} ${lastName}</td>
                                <td class="px-4 py-2 text-sm">${email}</td>
                                <td class="px-4 py-2 font-bold text-green-600">${amountStr}</td>
                                <td class="px-4 py-2">${proofBtn}</td>
                                <td class="px-4 py-2 text-xs">${created}</td>
                                <td class="px-4 py-2 space-x-1 flex flex-wrap gap-1">
                                    <button onclick="markAsPaid('${id}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">‚úì Verify</button>
                                    <button onclick="rejectOrder('${id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">‚úó Reject</button>
                                </td>
                            </tr>
                        `);
                    } catch (rowErr) {
                        console.warn('Error rendering order row, skipping order:', order, rowErr);
                    }
                }

                tbody.innerHTML = rows.join('') || '<tr><td colspan="7" class="px-4 py-2 text-gray-500">No pending orders</td></tr>';
            } catch (err) {
                console.error('Error displaying pending orders:', err);
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-2 text-red-500">Error rendering pending orders (see console)</td></tr>';
            }
        }

        function searchPendingOrders() {
            const searchTerm = document.getElementById('pendingSearchInput').value.toLowerCase().trim();

            if (!searchTerm) {
                displayPendingOrders(window.allPendingOrders || []);
                return;
            }

            const filtered = (window.allPendingOrders || []).filter(order =>
                order.id.toLowerCase().includes(searchTerm) ||
                order.customer.email.toLowerCase().includes(searchTerm) ||
                `${order.customer.firstName} ${order.customer.lastName}`.toLowerCase().includes(searchTerm)
            );

            displayPendingOrders(filtered);
            
            if (filtered.length === 0) {
                console.log('No orders found matching:', searchTerm);
                alert('No pending orders found matching: ' + searchTerm);
            }
        }

        // Allow Enter key to trigger search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('pendingSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchPendingOrders();
                    }
                });
            }
        });

        async function loadProducts() {
            const products = await getProducts();
            const tbody = document.getElementById('productsTable');
            
            tbody.innerHTML = products.map(product => `
                <tr class="border-b">
                    <td class="px-4 py-2">${product.name}</td>
                    <td class="px-4 py-2">${product.category}</td>
                    <td class="px-4 py-2">‚Ç¶${product.price.toLocaleString()}</td>
                    <td class="px-4 py-2 text-sm">${product.description.substring(0, 30)}...</td>
                    <td class="px-4 py-2">
                        <button onclick="deleteProduct('${product.id}')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('totalProducts').textContent = products.length;
        }

        async function loadStats() {
            try {
                const stats = await getOrderStats();
                document.getElementById('totalOrders').textContent = stats.totalOrders;
                // show NGN currency
                document.getElementById('totalRevenue').textContent = '‚Ç¶' + Number(stats.totalRevenue).toLocaleString();
            } catch (err) {
                console.error('Error loading stats:', err);
                // fallback to localStorage
                const orders = JSON.parse(localStorage.getItem('orders')) || [];
                document.getElementById('totalOrders').textContent = orders.length;
                const revenue = orders.reduce((sum, o) => sum + Number(o.total || 0), 0);
                document.getElementById('totalRevenue').textContent = '‚Ç¶' + Number(revenue).toLocaleString();
            }
        }

        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const product = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                category: document.getElementById('productCategory').value,
                image: document.getElementById('productImage').value,
                id: Math.random().toString(36).substr(2, 9)
            };

            await addProduct(product);
            document.getElementById('addProductForm').reset();
            loadProducts();
            alert('Product added successfully!');
        });

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                await deleteProductById(productId);
                loadProducts();
            }
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await logoutUser();
        });

        function viewProof(orderId) {
            // If Firestore is available, try to fetch the order document
            if (window.fb && fb.db) {
                (async () => {
                    try {
                        // Try direct doc lookup by id, otherwise query by order id field
                        let docRef = fb.db.collection('pendingBankTransfers').doc(orderId);
                        let doc = await docRef.get();
                        if (!doc.exists) {
                            const q = await fb.db.collection('pendingBankTransfers').where('id', '==', orderId).limit(1).get();
                            if (!q.empty) doc = q.docs[0];
                        }

                        const data = doc && doc.exists ? doc.data() : null;
                        if (!data) {
                            alert('No proof found');
                            return;
                        }

                        const proofUrl = (data.paymentProof && (data.paymentProof.dataUrl || data.paymentProofUrl)) || data.paymentProofUrl || null;
                        if (!proofUrl) {
                            alert('No proof image available for this order');
                            return;
                        }

                        const modal = window.open();
                        modal.document.write(`
                            <html>
                                <head><title>Payment Proof - ${data.id || orderId}</title></head>
                                <body style="margin: 0; padding: 20px; background: #f0f0f0;">
                                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; margin: 0 auto;">
                                        <h2>Payment Proof: ${data.id || orderId}</h2>
                                        <p>Customer: ${data.customer && (data.customer.firstName || '')} ${data.customer && (data.customer.lastName || '')}</p>
                                        <p>Amount: ‚Ç¶${(data.amounts && data.amounts.total) ? Number(data.amounts.total).toLocaleString() : '0'}</p>
                                        <img src="${proofUrl}" style="max-width: 100%; margin-top: 20px; border: 1px solid #ddd; border-radius: 4px;">
                                        <p style="margin-top: 20px; font-size: 12px; color: #666;">Uploaded: ${data.paymentProof && data.paymentProof.uploadedAt ? new Date(data.paymentProof.uploadedAt).toLocaleString() : ''}</p>
                                    </div>
                                </body>
                            </html>
                        `);
                    } catch (err) {
                        console.error('Error fetching proof from Firestore:', err);
                        alert('Error fetching proof (see console)');
                    }
                })();
                return;
            }

            // Fallback: localStorage
            const pendingOrders = JSON.parse(localStorage.getItem('pendingBankTransfers')) || [];
            const order = pendingOrders.find(o => o.id === orderId);

            if (!order || !order.paymentProof) {
                alert('No proof found');
                return;
            }

            // Open proof in a modal or new window
            const modal = window.open();
            modal.document.write(`
                <html>
                    <head><title>Payment Proof - ${order.id}</title></head>
                    <body style="margin: 0; padding: 20px; background: #f0f0f0;">
                        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 800px; margin: 0 auto;">
                            <h2>Payment Proof: ${order.id}</h2>
                            <p>Customer: ${order.customer.firstName} ${order.customer.lastName}</p>
                            <p>Amount: ‚Ç¶${order.amounts.total.toLocaleString()}</p>
                            <img src="${order.paymentProof.dataUrl}" style="max-width: 100%; margin-top: 20px; border: 1px solid #ddd; border-radius: 4px;">
                            <p style="margin-top: 20px; font-size: 12px; color: #666;">Uploaded: ${new Date(order.paymentProof.uploadedAt).toLocaleString()}</p>
                        </div>
                    </body>
                </html>
            `);
        }

        function markAsPaid(orderId) {
            if (!confirm('Mark this order as paid and complete the payment?\n\nThis will generate a receipt and send confirmation.')) {
                return;
            }
            // If Firestore is available, operate on Firestore documents
            if (window.fb && fb.db) {
                (async () => {
                    try {
                        // Find pending doc by doc id or by order.id field
                        let docRef = fb.db.collection('pendingBankTransfers').doc(orderId);
                        let doc = await docRef.get();
                        if (!doc.exists) {
                            const q = await fb.db.collection('pendingBankTransfers').where('id', '==', orderId).limit(1).get();
                            if (!q.empty) doc = q.docs[0];
                        }

                        if (!doc || !doc.exists) {
                            alert('Order not found in Firestore');
                            return;
                        }

                        const order = doc.data();
                        order.status = 'completed';
                        order.paymentId = 'BANK_' + Date.now();
                        order.completedAt = new Date().toISOString();
                        order.verifiedBy = fb.auth && fb.auth.currentUser ? fb.auth.currentUser.email : 'admin';
                        order.verifiedAt = new Date().toISOString();

                        // Write to orders collection
                        await fb.db.collection('orders').doc(order.id || doc.id).set(order);
                        // Delete pending doc
                        await fb.db.collection('pendingBankTransfers').doc(doc.id).delete();

                        // Optionally create receipt doc
                        const receiptHTML = generateReceiptHTML(order);
                        await fb.db.collection('receipts').add({ orderId: order.id, receipt: receiptHTML, generatedAt: new Date().toISOString() });

                        // Create email log doc
                        await fb.db.collection('emailLog').add({ type: 'order_completion', to: order.customer.email, subject: `Order Confirmed - BlessedShop #${order.id}`, orderId: order.id, sentAt: new Date().toISOString() });

                        alert(`Order #${orderId} has been marked as paid (Firestore). Receipt generated and email log created.`);
                        // Firestore listener will update the UI automatically
                    } catch (err) {
                        console.error('Error marking order as paid (Firestore):', err);
                        alert('Error marking order as paid (see console)');
                    }
                })();
                return;
            }

            // Fallback: localStorage-based flow
            const pendingOrders = JSON.parse(localStorage.getItem('pendingBankTransfers')) || [];
            const orderIndex = pendingOrders.findIndex(o => o.id === orderId);

            if (orderIndex === -1) {
                alert('Order not found');
                return;
            }

            const order = pendingOrders[orderIndex];

            // Mark as completed
            order.status = 'completed';
            order.paymentId = 'BANK_' + Date.now();
            order.completedAt = new Date().toISOString();
            order.verifiedBy = 'admin';
            order.verifiedAt = new Date().toISOString();

            // Move from pending to completed orders
            pendingOrders.splice(orderIndex, 1);
            localStorage.setItem('pendingBankTransfers', JSON.stringify(pendingOrders));

            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            orders.push(order);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Generate receipt
            const receiptHTML = generateReceiptHTML(order);
            const receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            receipts.push({
                orderId: order.id,
                receipt: receiptHTML,
                generatedAt: new Date().toISOString()
            });
            localStorage.setItem('receipts', JSON.stringify(receipts));

            // Send email notification (mock)
            const emailLog = JSON.parse(localStorage.getItem('emailLog')) || [];
            emailLog.push({
                type: 'order_completion',
                to: order.customer.email,
                subject: `Order Confirmed - BlessedShop #${order.id}`,
                orderId: order.id,
                sentAt: new Date().toISOString()
            });
            localStorage.setItem('emailLog', JSON.stringify(emailLog));

            alert(`Order #${orderId} has been marked as paid!\n\nReceipt generated and email sent to customer.`);
            loadPendingBankTransfers();
        }

        function rejectOrder(orderId) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            // Firestore path
            if (window.fb && fb.db) {
                (async () => {
                    try {
                        let docRef = fb.db.collection('pendingBankTransfers').doc(orderId);
                        let doc = await docRef.get();
                        if (!doc.exists) {
                            const q = await fb.db.collection('pendingBankTransfers').where('id', '==', orderId).limit(1).get();
                            if (!q.empty) doc = q.docs[0];
                        }

                        if (!doc || !doc.exists) {
                            alert('Order not found in Firestore');
                            return;
                        }

                        const order = doc.data();
                        order.status = 'rejected';
                        order.rejectionReason = reason;
                        order.rejectedAt = new Date().toISOString();

                        // Optionally write to a rejectedOrders collection
                        await fb.db.collection('rejectedOrders').doc(order.id || doc.id).set(order);
                        // Remove from pending
                        await fb.db.collection('pendingBankTransfers').doc(doc.id).delete();

                        // Email log
                        await fb.db.collection('emailLog').add({ type: 'order_rejected', to: order.customer.email, subject: `Order Rejected - BlessedShop #${order.id}`, reason, orderId: order.id, sentAt: new Date().toISOString() });

                        alert(`Order #${orderId} has been rejected (Firestore). Customer has been notified.`);
                        return;
                    } catch (err) {
                        console.error('Error rejecting order (Firestore):', err);
                        alert('Error rejecting order (see console)');
                    }
                })();
                return;
            }

            // Fallback: localStorage
            const pendingOrders = JSON.parse(localStorage.getItem('pendingBankTransfers')) || [];
            const orderIndex = pendingOrders.findIndex(o => o.id === orderId);

            if (orderIndex === -1) {
                alert('Order not found');
                return;
            }

            const order = pendingOrders[orderIndex];
            order.status = 'rejected';
            order.rejectionReason = reason;
            order.rejectedAt = new Date().toISOString();

            // Send rejection email (mock)
            const emailLog = JSON.parse(localStorage.getItem('emailLog')) || [];
            emailLog.push({
                type: 'order_rejected',
                to: order.customer.email,
                subject: `Order Rejected - BlessedShop #${order.id}`,
                reason: reason,
                orderId: order.id,
                sentAt: new Date().toISOString()
            });
            localStorage.setItem('emailLog', JSON.stringify(emailLog));

            // Remove from pending
            pendingOrders.splice(orderIndex, 1);
            localStorage.setItem('pendingBankTransfers', JSON.stringify(pendingOrders));

            alert(`Order #${orderId} has been rejected.\n\nReason: ${reason}\n\nCustomer has been notified.`);
            loadPendingBankTransfers();
        }

        function generateReceiptHTML(order) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; }
                        .receipt { border: 1px solid #ddd; padding: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .logo { font-size: 32px; margin-bottom: 10px; }
                        .company-name { font-size: 24px; font-weight: bold; }
                        .receipt-number { color: #666; margin-top: 10px; }
                        .section { margin: 20px 0; }
                        .section-title { font-weight: bold; border-bottom: 2px solid #333; padding-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .total-row { font-weight: bold; font-size: 16px; }
                        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header">
                            <div class="logo">üôè</div>
                            <div class="company-name">BLESSEDSHOP</div>
                            <div class="receipt-number">Receipt #${order.id}</div>
                            <div style="color: #666; font-size: 12px;">Date: ${new Date(order.completedAt).toLocaleString()}</div>
                        </div>

                        <div class="section">
                            <div class="section-title">Customer Information</div>
                            <p>Name: ${order.customer.firstName} ${order.customer.lastName}</p>
                            <p>Email: ${order.customer.email}</p>
                        </div>

                        <div class="section">
                            <div class="section-title">Payment Information</div>
                            <p>Payment Method: Bank Transfer (Access Bank)</p>
                            <p>Transaction ID: ${order.paymentId}</p>
                            <p>Status: <span style="color: green; font-weight: bold;">VERIFIED & PAID</span></p>
                        </div>

                        <div class="section">
                            <div class="section-title">Order Items</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.quantity}</td>
                                            <td>‚Ç¶${item.price.toLocaleString()}</td>
                                            <td>‚Ç¶${(item.price * item.quantity).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="section">
                            <table>
                                <tr>
                                    <td>Subtotal:</td>
                                    <td>‚Ç¶${order.amounts.subtotal.toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td>Shipping:</td>
                                    <td>‚Ç¶${order.amounts.shipping.toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td>Tax (10%):</td>
                                    <td>‚Ç¶${order.amounts.tax.toLocaleString()}</td>
                                </tr>
                                <tr class="total-row">
                                    <td>TOTAL:</td>
                                    <td>‚Ç¶${order.amounts.total.toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>

                        <div class="footer">
                            <p>Thank you for shopping with BlessedShop!</p>
                            <p>¬© 2025 BlessedShop. All rights reserved.</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }
    </script>
</body>
</html>
